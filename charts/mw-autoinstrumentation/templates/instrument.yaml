
apiVersion: opentelemetry.io/v1alpha1
kind: Instrumentation
metadata:
  name: mw-autoinstrumentation
  namespace: {{ .Release.Namespace }}
  annotations:
    {{- $skipPostUpgrade := and (not .Values.webhook.certManager.enabled) (.Release.IsUpgrade) }}
    {{- if $skipPostUpgrade }}
    "helm.sh/hook": post-install
    {{- else }}
    "helm.sh/hook": post-install,post-upgrade
    {{- end }}
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  exporter:
    endpoint: http://mw-service.{{ .Release.Namespace }}:9319
  propagators:
    - tracecontext
    - baggage
    - b3
  sampler:
    type: parentbased_traceidratio
    argument: "1.0"
  python:
    env:
      - name: MW_AGENT_SERVICE
        value: mw-service.{{ .Release.Namespace }}.svc.cluster.local
      - name: GIT_PYTHON_REFRESH
        value: quiet
      - name: MW_K8S_PYTHON_INSTRUMENTATION
        value: 'true'
      - name: MW_TRACKER
        value: 'false'
      - name: OTEL_EXPORTER_OTLP_ENDPOINT
        value: http://mw-service.{{ .Release.Namespace }}:9320
      - name: MW_API_KEY
        value: {{ or .Values.global.mw.apiKey "XXXXXX" | quote }}
      - name: OTEL_PROPAGATORS
        value: tracecontext,baggage,b3
  nodejs:
    image: '{{ .Values.mw.images.autoinstrumentationNode.repository | default "ghcr.io/middleware-labs/opentelemetry-operator/autoinstrumentation-node" }}:{{ .Values.mw.images.autoinstrumentationNode.tag | default "0.0.2" }}'
    env:
      - name: OTEL_NODE_DISABLED_INSTRUMENTATIONS
        value: fs,dns,net
      - name: OTEL_PROPAGATORS
        value: b3,tracecontext,baggage
      - name: MW_API_KEY
        value: {{ or .Values.global.mw.apiKey "XXXXXX" | quote }}
      - name: MW_AGENT_SERVICE
        value: mw-service.{{ .Release.Namespace }}.svc.cluster.local
  go:
    env:
      - name: OTEL_EXPORTER_OTLP_ENDPOINT
        value: http://mw-service.{{ .Release.Namespace }}:9319
      - name: OTEL_EXPORTER_OTLP_PROTOCOL
        value: grpc
      - name: OTEL_PROPAGATORS
        value: b3,tracecontext,baggage
  dotnet:
    env:
      - name: OTEL_EXPORTER_OTLP_ENDPOINT
        value: http://mw-service.{{ .Release.Namespace }}:9320
      - name: OTEL_PROPAGATORS
        value: b3,tracecontext,baggage
  java:
    env:
      - name: MW_AGENT_SERVICE
        value: mw-service.{{ .Release.Namespace }}.svc.cluster.local
      - name: OTEL_EXPORTER_OTLP_ENDPOINT
        value: http://mw-service.{{ .Release.Namespace }}:9319
      - name: OTEL_EXPORTER_OTLP_PROTOCOL
        value: grpc
      - name: MW_API_KEY
        value: {{ or .Values.global.mw.apiKey "XXXXXX" | quote }}
      - name: OTEL_PROPAGATORS
        value: tracecontext,baggage,b3
---
apiVersion: opentelemetry.io/v1alpha1
kind: Instrumentation
metadata:
  name: mw-autoinstrumentation-alpine
  namespace: {{ .Release.Namespace }}
  annotations:
    {{- $skipPostUpgrade := and (not .Values.webhook.certManager.enabled) (.Release.IsUpgrade) }}
    {{- if $skipPostUpgrade }}
    "helm.sh/hook": post-install
    {{- else }}
    "helm.sh/hook": post-install,post-upgrade
    {{- end }}
    "helm.sh/hook-weight": "6"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  exporter:
    endpoint: http://mw-service.{{ .Release.Namespace }}:9319
  propagators:
    - tracecontext
    - baggage
    - b3
  sampler:
    type: parentbased_traceidratio
    argument: "1.0"
  nodejs:
    image: '{{ .Values.mw.images.autoinstrumentationNodeAlpine.repository | default "ghcr.io/middleware-labs/opentelemetry-operator/autoinstrumentation-node-alpine" }}:{{ .Values.mw.images.autoinstrumentationNodeAlpine.tag | default "0.0.2" }}'
    env:
      - name: OTEL_NODE_DISABLED_INSTRUMENTATIONS
        value: fs,dns,net
      - name: OTEL_PROPAGATORS
        value: b3,tracecontext,baggage
      - name: MW_API_KEY
        value: {{ or .Values.global.mw.apiKey "XXXXXX" | quote }}
      - name: MW_AGENT_SERVICE
        value: mw-service.{{ .Release.Namespace }}.svc.cluster.local